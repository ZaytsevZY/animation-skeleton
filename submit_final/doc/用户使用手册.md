# 骨架绑定系统 - 用户使用手册

## 概述

本手册将指导您如何使用骨架绑定系统完成从模型加载到动画输出的完整工作流程。

## 系统要求

### 硬件要求
- **操作系统**：Windows 10/11, macOS 10.14+, Ubuntu 18.04+
- **处理器**：Intel i5或同等AMD处理器
- **内存**：4GB RAM以上
- **显卡**：支持OpenGL 3.3的显卡
- **硬盘空间**：500MB可用空间

### 软件要求
- **Python**：3.7或更高版本
- **依赖库**：详见requirements.txt文件

## 安装指南

### Windows系统

#### 方法1：一键安装（推荐）
1. 下载完整的submit_final文件夹
2. 双击运行`submit_final/bin/run.bat`
3. 程序将自动检查并提示安装缺失的依赖

#### 方法2：手动安装
1. 安装Python 3.7+（从python.org下载）
2. 打开命令提示符（CMD）
3. 导航到项目目录：
   ```cmd
   cd 路径\到\submit_final\src
   ```
4. 安装依赖：
   ```cmd
   pip install -r requirements.txt
   ```
5. 运行程序：
   ```cmd
   python main.py
   ```

### macOS系统

#### 方法1：终端安装
1. 打开终端
2. 导航到项目目录：
   ```bash
   cd 路径/到/submit_final/src
   ```
3. 安装依赖：
   ```bash
   pip3 install -r requirements.txt
   ```
4. 运行程序：
   ```bash
   python3 main.py
   ```

#### 方法2：Anaconda安装
1. 安装Anaconda
2. 创建新环境：
   ```bash
   conda create -n rigging python=3.8
   conda activate rigging
   ```
3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
4. 运行程序：
   ```bash
   python main.py
   ```

### Linux系统

#### Ubuntu/Debian
```bash
# 安装Python和pip
sudo apt update
sudo apt install python3 python3-pip

# 导航到项目目录
cd 路径/到/submit_final/src

# 安装依赖
pip3 install -r requirements.txt

# 运行程序
python3 main.py
```

## 快速开始

### 1. 启动程序

#### Windows用户
- 双击`submit_final/bin/run.bat`即可启动

#### 所有平台
- 打开终端/命令提示符
- 运行：
  ```bash
  cd submit_final/src
  python main.py
  ```

### 2. 首次运行

程序启动后会自动：
- 检查所有依赖是否安装
- 加载默认的cow模型
- 计算骨架绑定权重
- 显示3D交互界面

### 3. 界面介绍

#### 主窗口布局
```
┌─────────────────────────────────────────┐
│  菜单栏：文件、视图、帮助                 │
├─────────────────────────────────────────┤
│  工具栏：重置、导出、模式切换             │
├─────────────────┬───────────────────────┤
│                 │                       │
│   3D视图区域     │    控制面板           │
│                 │                       │
│   - 模型显示     │    - 权重模式选择     │
│   - 骨架显示     │    - 关节信息         │
│   - 交互控制     │    - 导出选项         │
│                 │                       │
├─────────────────┴───────────────────────┤
│  状态栏：显示当前操作和坐标信息            │
└─────────────────────────────────────────┘
```

#### 3D视图操作
- **旋转视角**：左键拖拽
- **缩放**：鼠标滚轮
- **平移**：右键拖拽
- **选择关节**：左键点击红色球体

## 详细使用指南

### 1. 模型加载

#### 支持的文件格式
- **GLB/GLTF**（推荐）：包含网格和骨架
- **OBJ**：纯网格数据
- **FBX**：Autodesk格式

#### 加载自定义模型
1. 将模型文件放入`submit_final/src/data/`目录
2. 创建与模型同名的文件夹
3. 在程序中选择"文件"→"加载模型"
4. 选择对应的模型文件

#### 模型要求
- 模型应该具有合理的几何结构
- 建议使用单位化坐标（-1到1之间）
- 面数建议在1000-50000之间以保证性能

### 2. 骨架创建

#### 自动骨架生成
程序会根据模型形状自动创建基础骨架：
1. 计算模型包围盒
2. 创建根关节在中心位置
3. 根据模型特征添加子关节

#### 手动骨架调整
1. **显示骨架**：点击"显示骨架"按钮
2. **选择关节**：点击红色球体选中关节
3. **移动关节**：
   - 拖拽黄色箭头沿轴移动
   - 使用键盘方向键微调
   - 按住Shift键进行精确控制

#### 骨架验证
- 红色：根关节（不可移动）
- 蓝色：普通关节
- 绿色：选中关节
- 黄色：正在拖拽的关节

### 3. 权重计算

#### 权重模式选择

##### 1. 最近邻权重（简化模式）
- **特点**：每个顶点只绑定到最近的骨骼
- **适用**：快速预览、调试
- **操作**：点击"简化权重"按钮

##### 2. 热扩散权重（完整模式）
- **特点**：平滑的权重过渡，考虑全局信息
- **适用**：高质量动画
- **操作**：点击"完整权重"按钮
- **注意**：计算时间较长（5-30秒）

#### 权重可视化
- **颜色显示**：权重越大的区域颜色越深
- **透明度**：可以调整权重显示透明度
- **选择查看**：可以单独查看某个骨骼的影响区域

### 4. 交互操作

#### 关节操作

##### 选择关节
1. **鼠标点击**：直接点击红色球体
2. **键盘选择**：
   - Tab：下一个关节
   - Shift+Tab：上一个关节
   - 数字键：直接选择对应编号的关节

##### 移动关节
1. **拖拽模式**：
   - 选中关节后显示黄色箭头
   - 拖拽箭头沿轴移动
   - 按住Ctrl键自由移动

2. **精确控制**：
   - 使用属性面板输入具体数值
   - 支持相对移动和绝对定位
   - 可以设置移动步长

##### 旋转关节
1. **旋转模式**：
   - 按住R键进入旋转模式
   - 拖拽旋转控制器
   - 支持欧拉角和四元数旋转

#### 模型操作

##### 视图控制
- **重置视角**：按空格键
- **前视图**：按F键
- **顶视图**：按T键
- **右视图**：按R键
- **透视/正交**：按P键切换

##### 模型显示
- **线框模式**：按W键
- **实体模式**：按S键
- **半透明**：按X键
- **隐藏/显示骨架**：按H键

### 5. 数据导出

#### 导出类型

##### 1. 骨架信息
- **文件格式**：JSON
- **内容**：
  - 关节名称和层次关系
  - 绑定姿势和当前姿势
  - 变换矩阵
  - 偏移向量

**示例文件**：
```json
{
  "joints": [
    {
      "index": 0,
      "name": "root",
      "parent": -1,
      "bind_position": [0.0, 0.0, 0.0],
      "current_position": [0.0, 0.0, 0.0],
      "transform": [[1,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1]]
    }
  ],
  "bones": [
    {
      "parent": 0,
      "child": 1,
      "length": 1.0
    }
  ]
}
```

##### 2. 权重信息
- **文件格式**：JSON
- **内容**：
  - 顶点坐标
  - 权重矩阵
  - 骨骼映射表

**示例文件**：
```json
{
  "vertices": [[0.1, 0.2, 0.3], [0.4, 0.5, 0.6]],
  "weights": {
    "full": [[0.8, 0.2], [0.3, 0.7]],
    "simple": [[1.0, 0.0], [0.0, 1.0]]
  },
  "bones": ["bone_1", "bone_2"]
}
```

##### 3. 完整项目
- **文件格式**：ZIP压缩包
- **内容**：
  - 模型文件
  - 骨架数据
  - 权重数据
  - 配置文件

#### 导出操作
1. **选择导出类型**：在控制面板中选择
2. **设置文件名**：输入导出文件名
3. **选择保存位置**：选择保存目录
4. **点击导出**：开始导出过程

### 6. 动画制作

#### 关键帧动画
1. **设置初始姿势**：调整关节到起始位置
2. **添加关键帧**：
   - 点击"添加关键帧"按钮
   - 或使用快捷键K
3. **调整时间**：拖动时间滑块
4. **设置结束姿势**：调整关节到结束位置
5. **播放动画**：点击播放按钮

#### 动画导出
1. **录制屏幕**：
   - 使用系统录屏工具
   - 或OBS等专业录屏软件
2. **导出序列帧**：
   - 设置导出路径
   - 选择帧率（24/30/60 fps）
   - 选择图片格式（PNG/JPG）

## 高级功能

### 1. 多模型支持

#### 同时加载多个模型
1. 文件 → 加载多个模型
2. 选择多个模型文件
3. 设置相对位置和比例
4. 创建共享骨架或独立骨架

#### 模型交互
- **相对位置**：设置模型间的相对位置
- **共享骨架**：多个模型使用同一骨架
- **独立控制**：每个模型独立控制

### 2. 权重编辑

#### 手动权重调整
1. **权重绘制**：
   - 选择权重绘制工具
   - 设置画笔大小和强度
   - 直接在模型上绘制权重

2. **权重平滑**：
   - 选择权重平滑工具
   - 设置平滑参数
   - 一键平滑权重分布

### 3. 骨骼编辑

#### 骨骼创建
1. **手动添加**：
   - 点击"添加骨骼"按钮
   - 选择父关节
   - 设置子关节位置

2. **自动检测**：
   - 分析模型几何特征
   - 自动生成合适的骨骼
   - 支持对称骨骼创建

#### 骨骼调整
- **长度调整**：拖拽骨骼末端
- **方向调整**：旋转骨骼方向
- **层次调整**：修改父子关系

## 故障排除

### 常见问题

#### 1. 程序无法启动
**症状**：双击无反应或报错
**解决方案**：
1. 检查Python是否安装
2. 检查所有依赖是否安装
3. 查看错误日志文件
4. 尝试从命令行启动查看详细错误

#### 2. 模型无法加载
**症状**：模型不显示或显示异常
**解决方案**：
1. 检查模型文件是否存在
2. 检查文件格式是否支持
3. 检查模型文件是否损坏
4. 尝试简化模型或转换格式

#### 3. 权重计算失败
**症状**：权重显示异常或计算报错
**解决方案**：
1. 检查骨架是否正确创建
2. 检查模型是否封闭
3. 尝试使用简化权重模式
4. 检查内存是否充足

#### 4. 界面卡顿
**症状**：操作不流畅，响应慢
**解决方案**：
1. 降低模型复杂度
2. 关闭不必要的显示选项
3. 增加系统内存
4. 使用GPU加速（如果支持）

### 性能优化

#### 1. 模型优化
- **减少面数**：使用简化后的模型
- **合并顶点**：去除重复顶点
- **优化拓扑**：保持网格质量

#### 2. 显示优化
- **LOD设置**：根据距离调整细节
- **视锥剔除**：不显示视野外的部分
- **延迟渲染**：优化渲染管线

### 技术支持

#### 获取帮助
1. **查看日志**：程序运行日志保存在`output/logs/`目录
2. **在线文档**：访问项目文档获取最新信息
3. **邮件支持**：联系助教邮箱1729406968@qq.com

#### 报告问题
1. **收集信息**：
   - 操作系统版本
   - Python版本
   - 错误截图或日志
   - 复现步骤
2. **联系支持**：通过邮件或课程群反馈

## 快捷键列表

### 视图操作
- `鼠标左键拖拽`：旋转视角
- `鼠标右键拖拽`：平移视角
- `鼠标滚轮`：缩放
- `空格键`：重置视角

### 选择操作
- `左键点击`：选择关节
- `Tab`：下一个关节
- `Shift+Tab`：上一个关节
- `Esc`：取消选择

### 变换操作
- `G`：移动模式
- `R`：旋转模式
- `S`：缩放模式
- `X/Y/Z`：约束到坐标轴

### 显示控制
- `W`：线框模式
- `S`：实体模式
- `H`：显示/隐藏骨架
- `F`：前视图
- `T`：顶视图
- `R`：右视图

## 最佳实践

### 1. 工作流程
1. **准备模型**：确保模型质量良好
2. **创建骨架**：根据模型特征设计骨架
3. **调整权重**：选择合适的权重算法
4. **测试变形**：测试各种姿势下的变形效果
5. **导出数据**：保存最终配置

### 2. 性能建议
- **模型大小**：控制在1000-10000面之间
- **骨骼数量**：5-20根骨骼为最佳
- **权重精度**：使用float32即可满足需求

### 3. 质量优化
- **权重平滑**：使用热扩散算法获得最佳效果
- **姿态测试**：测试极端姿态下的变形
- **细节调整**：手动微调异常区域的权重

## 版本更新

### 当前版本：v1.0
- 基础骨架绑定功能
- 三种权重计算算法
- 实时交互界面
- 数据导出功能

### 即将推出：v1.1
- 动画时间轴编辑
- 更多权重算法
- 性能优化
- 更多模型格式支持

---

**文档版本**：v1.0
**更新日期**：2025年12月31日
**作者**：计算机动画课程团队