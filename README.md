# 🎭 计算机动画骨架绑定系统

这是一个完整的骨架绑定系统，实现了线性混合蒙皮（LBS）算法，支持从模型加载、权重计算到动画渲染的完整流程。

## 🚀 功能特性

- **完整的工作流程**：从模型加载到动画输出
- **多种权重计算**：最近邻、双骨插值、热扩散算法
- **实时交互界面**：基于PyQt5的3D可视化界面
- **多种动画支持**：支持FBX、GLB动画数据
- **骨架驱动变形**：通过拖拽关节实时驱动模型变形
- **数据导出**：支持骨架、权重、完整项目信息导出

## 📁 项目结构

```
animation-skeleton/
├── 📂 data/
│   └── 📂 cow/
│       ├── 📄 cow.fbx          # FBX格式的模型文件
│       ├── 📄 cow.glb          # GLB格式的模型文件
│       └── 📄 cow.obj          # OBJ格式的模型文件
├── 📂 submit_final/
│   ├── 📂 bin/
│   │   └── 📄 run.bat          # Windows启动脚本
│   ├── 📂 doc/
│   └── 📂 src/
│       ├── 📂 data/
│       │   └── 📂 cow/
│       ├── 📂 rigging/
│       │   ├── 📄 __init__.py
│       │   ├── 📄 lbs.py           # 线性混合蒙皮实现
│       │   ├── 📄 mesh_io.py       # 网格IO操作
│       │   ├── 📄 skeleton_loader.py
│       │   ├── 📄 skeleton.py      # 骨架数据结构
│       │   ├── 📄 weights_heat.py  # 热扩散权重算法
│       │   └── 📄 weights_nearest.py
│       ├── 📄 main.py
│       ├── 📄 requirements.txt
│       └── 📄 ui_simple.py
├── 📂 submit_mid/
└── 📄 README.md
```

## 🎯 快速开始

### 1. 环境准备

```bash
# 安装依赖
cd submit_final/src
pip install -r requirements.txt
```

### 2. 运行程序

#### Windows用户

双击运行：

```bash
submit_final/bin/run.bat
```

#### 所有平台

```bash
cd submit_final/src
python main.py
```

## 🛠️ 核心模块

### 1. 骨架系统 (`rigging/`)

#### skeleton.py - 骨架数据结构
- 定义关节层次结构和变换矩阵
- 支持前向运动学(FK)计算
- 管理关节的绑定姿势和当前姿势

#### skeleton_loader.py - 骨架加载器
- 从GLB/GLTF文件加载骨架和网格数据
- 处理关节层次关系和初始变换
- 支持模型缩放和单位转换

#### mesh_io.py - 网格IO操作
- 加载和处理3D模型网格数据
- 支持多种格式：OBJ、FBX、GLB
- 提供网格顶点和面片数据访问

### 2. 权重计算算法

#### weights_nearest.py - 最近邻权重
- 每个顶点只绑定到最近的关节
- 简单快速，适合预览和调试
- 权重为0或1的二元绑定

#### weights_heat.py - 热扩散权重
- 基于热平衡方程的权重计算
- 提供平滑的权重过渡
- 支持多关节影响，变形质量更高

#### lbs.py - 线性混合蒙皮
- 实现标准的线性混合蒙皮算法
- 支持多种权重模式的实时切换
- 提供高效的顶点变形计算

### 3. 用户界面 (`ui_simple.py`)

#### 交互功能
- **关节选择**：点击红色球体选择骨架关节
- **拖拽控制**：黄色箭头沿轴移动关节
- **模式切换**：完整蒙皮 vs 简化蒙皮
- **重置功能**：一键恢复到初始状态

#### 导出功能
- **骨架信息**：关节位置、层次关系、变换矩阵
- **权重信息**：顶点权重、绑定数据
- **完整信息**：项目运行状态的完整快照

## 📊 数据格式

### 支持的模型格式
- **GLB/GLTF**（推荐）：包含网格和骨架信息
- **OBJ**：纯网格数据（需手动创建骨架）
- **FBX**：Autodesk格式，支持复杂动画

### 导出文件结构

#### 骨架信息文件
```json
{
  "joints": [
    {
      "index": 0,
      "name": "root",
      "parent": -1,
      "bind_position": [x, y, z],
      "current_position": [x, y, z],
      "transform": [4x4矩阵]
    }
  ]
}
```

#### 权重信息文件
```json
{
  "vertices": [...],
  "weights": {
    "full": [...],      // 完整权重
    "simple": [...]     // 简化权重
  }
}
```

## 🎮 使用流程

1. **启动程序**：运行 `python main.py`
2. **加载模型**：程序自动加载 `data/cow/` 下的模型
3. **骨架绑定**：自动计算顶点-关节权重
4. **交互控制**：
   - 点击红色球体选择关节
   - 拖拽黄色箭头移动关节
   - 观察模型实时变形
5. **数据导出**：点击相应按钮导出数据

## 🎓 课程相关

本项目是计算机动画算法与技术课程的骨架绑定大作业，实现了：

- **骨架层次结构管理**：支持复杂的多级骨架
- **多种权重算法**：从简单到复杂的权重计算
- **实时变形系统**：高效的线性混合蒙皮实现
- **交互式可视化**：基于PyQt5的3D界面
- **数据持久化**：完整的项目状态保存和恢复

## 🔧 技术栈

- **Python 3.7+**：核心开发语言
- **PyQt5**：GUI框架和事件处理
- **PyVista**：3D可视化和交互
- **NumPy**：数值计算和矩阵运算
- **Trimesh**：3D网格处理
- **VTK**：底层3D渲染引擎

## 📋 系统要求

- **操作系统**：Windows 10/11, macOS, Linux
- **Python版本**：3.7或更高版本
- **内存要求**：至少4GB RAM
- **显卡要求**：支持OpenGL 3.3或更高版本

## 💡 开发提示

- 模型文件放在 `submit_final/src/data/cow/` 目录下
- 导出文件保存在 `submit_final/src/output/` 目录
- 使用Blender可以创建自定义骨架并导出为GLB格式
- 权重算法可以根据需要切换简化或完整模式